---
layout    : post
title     : 路由器和网关
date      : 2015-03-02
category  : [使用配置]
tags      : [路由器]
typora-root-url: ../img
---


BSD 路由器简介

<!-- more -->

# 简介

A “route” is a defined pair of addresses: a “destination” and a “gateway”，这表示如果要到达目标destination，必须通过gateway。

对于目标通常可以分为三种类型：独立的hosts，子网sunets，和默认目标default。

对应的也有三种类型的网关：    独立hosts，接口interfaces（也称作连接link），和Mac地址。


# 路由表

使用 netstat -nr 可以列出当前使用的路由表

    Destination        Gateway            Flags        Refs      Use   Netif Expire
    default            192.168.12.1       UGSc           27        8     en4
    default            192.168.12.2       UGScI           1        0     en0
    127                127.0.0.1          UCS             0        0     lo0
    127.0.0.1          127.0.0.1          UH              8   299005     lo0
    169.254            link#4             UCS             0        0     en4
    169.254            link#5             UCSI            0        0     en0
    192.168.12         link#4             UCS             0        0     en4
    192.168.12.1/32    link#4             UCS             2        0     en4
    192.168.12.1       40:16:9f:61:5b:e6  UHLWIir        27        0     en4   1089
    192.168.12.2/32    link#4             UCS             1        0     en4
    192.168.12.2       38:c9:86:43:2d:7d  UHLWI           0      384     lo0
    192.168.12.2       link#5             UHLWIir         1        0     en0
    192.168.12.2/32    link#5             UCSI            1        0     en0
    192.168.13         link#5             UCS             1        0     en0
    192.168.13.1/32    link#5             UCS             0        0     en0
    192.168.13.2       f4:31:c3:8c:ec:d4  UHLWIi          1      184     en0   1167
    224.0.0/4          link#4             UmCS            2        0     en4
    224.0.0/4          link#5             UmCSI           1        0     en0
    224.0.0.251        1:0:5e:0:0:fb      UHmLWI          0        0     en4
    239.255.255.250    1:0:5e:7f:ff:fa    UHmLWI          0     1297     en4
    239.255.255.250    1:0:5e:7f:ff:fa    UHmLWI          0        4     en0
    255.255.255.255/32 link#4             UCS             0        0     en4
    255.255.255.255/32 link#5             UCSI            0        0     en0


    Destination        Gateway            Flags        Refs      Use   Netif Expire
    default            192.168.12.1       UGSc           52     3189     en4
    default            link#10            UCSI            0        0 bridge1
    127                127.0.0.1          UCS             0        0     lo0
    127.0.0.1          127.0.0.1          UH              9   304468     lo0
    169.254            link#4             UCS             0        0     en4
    169.254            link#5             UCSI            1        0     en0
    169.254.227.203/32 link#5             UCS             0        0     en0
    192.168.2          link#10            UC              1        0 bridge1
    192.168.2.4        f4.31.c3.8c.ec.d4  UHLWIi          3     1974 bridge1   1169
    192.168.12         link#4             UCS             0        0     en4
    192.168.12.1/32    link#4             UCS             1        0     en4
    192.168.12.1       40:16:9f:61:5b:e6  UHLWIir        52        3     en4   1012
    192.168.12.2/32    link#4             UCS             1        0     en4
    192.168.12.2       38:c9:86:43:2d:7d  UHLWI           0       24     lo0
    224.0.0/4          link#4             UmCS            2        0     en4
    224.0.0/4          link#5             UmCSI           0        0     en0
    224.0.0.251        1:0:5e:0:0:fb      UHmLWI          0        0     en4
    239.255.255.250    1:0:5e:7f:ff:fa    UHmLWI          0      210     en4
    255.255.255.255/32 link#4             UCS             0        0     en4
    255.255.255.255/32 link#5             UCSI            0        0     en0

"去往Destination的数据，都通过Netif，发给Gateway，"

netif 列就是interface，lo0为lookback device。对于其中第四行表示：对于去往目标127.0.0.1的数据，使用接口lo0，这表示去往这个目标（也就是127.0.0.1）的数据都应该是内部的（internal），不要把数据send out

BSD会自动识别本地以太网上的目标，并为其添加一条路由。BSD也会为本地子网（local subnet）添加路由。link#4表示本系统的第4个以太网卡（有可能是虚拟的）

expire 过期时间，表示在此时间，还没有从目标传回任何数据，the route to this host will be automatically deleted

## Flags


U | 活动的 Up: The route is active.
H | 这条路由中的目标是一个单独 host Host: The route destination is a single host.
G | Gateway: Send anything for this destination on to this remote system, which will figure out from there where to send it.
S | 静态路由 Static: This route was configured manually, not automatically generated by the system.
C | Clone: Generates a new route based upon this route for machines we connect to. This type of route is normally used for local networks.
W | WasCloned: Indicated a route that was auto-configured based upon a local area network (Clone) route.
L | Link: Route involves references to Ethernet hardware.

## 默认路由 default

当local system 要和一个host通信，首先会检查路由表中是否有可达的路径。If the remote host falls into a subnet that we know how to reach (Cloned routes), then the system checks to see if it can connect along that interface.

如果没有路径可达，数据包就会被发送给Default。默认路由的flags中会有一个小写的c。对于一个局域网中的一台主机来说，这个默认路由的网关部分，可以设置为whatever machine has a **direct** connection to the outside world (whether via PPP link, DSL, cable modem, T1, or another network interface).

如果本台机器本身就是作为网关连接外部世界的，那么then the default route will be the gateway machine at your Internet Service Provider's (ISP) site.

## 举例

![存在的连接](/img/network/routes.png)


配置前RouterA

    % netstat -nr
    Routing tables

    Internet:
    Destination        Gateway            Flags    Refs      Use  Netif  Expire
    default            10.0.0.1           UGS         0    49378    xl0
    127.0.0.1          127.0.0.1          UH          0        6    lo0
    10.0.0.0/24        link#1             UC          0        0    xl0
    192.168.1.0/24     link#2             UC          0        0    xl1

问题
    # RouterA does not have a route to the 192.168.2.0/24 network

配置RouterA

    # route add -net 192.168.2.0/24 192.168.1.2
